steps:
# - script: echo Region=$(REGION), ConfigID=$(ciid), Portfolio=$(portfolio), ServiceConnection=$(t0ServiceConnection), CloudFormationStack=$(CFStackName), BucketName=$(S3BucketName), Environment=$(Environment), appltag=$(appl), BuildServerBucket=$(s3), FunctionName=$(function), KMSKEY=$(kmskeyid), BuildID=$(Build.BuildId), Mailto=$(supportchannel), supportedby=$(supportedby)
#   displayName: 'variable group devops-dev-linux2ami metadata'

- task: ReplaceTokens@1
  displayName: Replace lambda-python tokens
  inputs:
    sourcePath: $(Build.SourcesDirectory)/ADO-GoldenAMI/Linux-AMI/src
    filePattern: lambda_function.py
    tokenRegex: __(\w+)__

- task: ArchiveFiles@2
  displayName: 'Zip Lambda'
  inputs:
    rootFolderOrFile: ADO-GoldenAMI/Linux-AMI/src
    includeRootFolder: false
    archiveFile: '$(Build.ArtifactStagingDirectory)/lambda/$(S3BucketName)-$(Build.BuildId).zip'

- task: CopyFiles@2
  displayName: 'Copy Lambda'
  inputs:
    SourceFolder: 'ADO-GoldenAMI/Linux-AMI/src/'
    Contents: '**.py'
    TargetFolder: '$(Build.ArtifactStagingDirectory)/ADO-GoldenAMI/Linux-AMI/src/'

- task: ReplaceTokens@1
  displayName: Replace s3-cloudformation tokens
  inputs:
    sourcePath: $(Build.SourcesDirectory)/ADO-GoldenAMI/Linux-AMI/iac
    filePattern: create-S3.yaml
    tokenRegex: __(\w+)__

#### Create S3 Bucket ####
- task: AmazonWebServices.aws-vsts-tools.CloudFormationCreateOrUpdateStack.CloudFormationCreateOrUpdateStack@1
  displayName: 'Create/Update: $(S3StackName)'
  inputs:
    awsCredentials: $(devServiceConnection)
    regionName: $(REGION)
    stackName: $(S3StackName)
    templateFile: $(Build.SourcesDirectory)/ADO-GoldenAMI/Linux-AMI/iac/create-S3.yaml
    templateParametersSource: inline
    templateParameters: |
      [{
      "ParameterKey": "S3BucketName",
      "ParameterValue": '$(S3BucketName)'
      },
      {
      "ParameterKey": "Environment",
      "ParameterValue": '$(Environment)'
      },
      {
      "ParameterKey": "Region",
      "ParameterValue": $(REGION)
      }]
    capabilityAutoExpand: true
    tags: |
      Name=$(S3StackName)
      portfolio=$(portfolio)
      appl=$(appl)
      supportedby=$(supportedby)
      supportchannel=$(supportchannel)
      region=$(REGION)

#### Upload Lambda Zip file into S3-Bucket ####
- task: S3Upload@1
  displayName: Upload Zip to s3
  inputs:
    awsCredentials: $(devServiceConnection)
    regionName: $(REGION)
    bucketName: $(S3BucketName)-$(REGION)
    sourceFolder: $(Build.ArtifactStagingDirectory)/lambda

#### Create AMI Service role/Instance Profile ####
- task: ReplaceTokens@1
  displayName: Replace lambda-cloudformation tokens
  inputs:
    sourcePath: $(Build.SourcesDirectory)/ADO-GoldenAMI/Linux-AMI/iac
    filePattern: create-rotateami-lambda.yaml
    tokenRegex: __(\w+)__

- task: AmazonWebServices.aws-vsts-tools.CloudFormationCreateOrUpdateStack.CloudFormationCreateOrUpdateStack@1
  displayName: 'Create/Update: $(LambdaStackName)'
  inputs:
    awsCredentials: $(devServiceConnection)
    regionName: $(REGION)
    stackName: $(LambdaStackName)
    templateFile: $(Build.SourcesDirectory)/ADO-GoldenAMI/Linux-AMI/iac/create-rotateami-lambda.yaml
    templateParametersSource: inline
    templateParameters: |
      [{
      "ParameterKey":"BuildId",
      "ParameterValue":"$(Build.BuildId)"
      },
      {
      "ParameterKey": "S3BucketName",
      "ParameterValue": '$(S3BucketName)'
      },
      {
      "ParameterKey": "Environment",
      "ParameterValue": '$(Environment)'
      },
      {
      "ParameterKey": "kmskeyid",
      "ParameterValue": $(kmskeyid)
      }]
    capabilityAutoExpand: true
    tags: |
      Name=$(LambdaStackName)
      portfolio=$(portfolio)
      appl=$(appl)
      supportedby=$(supportedby)
      supportchannel=$(supportchannel)
      region=$(REGION)